<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>系统的数据一致性到底是在说什么 | Sam的个人博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="作为一名程序员，你是不是经常在很多场景，例如看博客、聊天吹水等等时候听到这样一个词”系统数据一致性”，是不是有时候感觉到了迷糊，不知道这个”系统数据一致性”到底是在说什么？其实，你可能只是不明白这个词，但是你肯定在实际工作中发现、解决过这样的问题。">
<meta name="keywords" content="分布式,一致性">
<meta property="og:type" content="article">
<meta property="og:title" content="系统的数据一致性到底是在说什么">
<meta property="og:url" content="https:&#x2F;&#x2F;ydstudios.gitee.io&#x2F;post&#x2F;e544327e.html">
<meta property="og:site_name" content="Sam的个人博客">
<meta property="og:description" content="作为一名程序员，你是不是经常在很多场景，例如看博客、聊天吹水等等时候听到这样一个词”系统数据一致性”，是不是有时候感觉到了迷糊，不知道这个”系统数据一致性”到底是在说什么？其实，你可能只是不明白这个词，但是你肯定在实际工作中发现、解决过这样的问题。">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https:&#x2F;&#x2F;gitee.com&#x2F;ydstudios&#x2F;blogImage&#x2F;raw&#x2F;master&#x2F;img&#x2F;20210117223211.png">
<meta property="og:image" content="https:&#x2F;&#x2F;gitee.com&#x2F;ydstudios&#x2F;blogImage&#x2F;raw&#x2F;master&#x2F;img&#x2F;20210131220214.png">
<meta property="og:image" content="https:&#x2F;&#x2F;gitee.com&#x2F;ydstudios&#x2F;blogImage&#x2F;raw&#x2F;master&#x2F;img&#x2F;20210131215841.png">
<meta property="og:updated_time" content="2021-02-04T12:21:00.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https:&#x2F;&#x2F;gitee.com&#x2F;ydstudios&#x2F;blogImage&#x2F;raw&#x2F;master&#x2F;img&#x2F;20210117223211.png">
  
    <link rel="alternate" href="/atom.xml" title="Sam的个人博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Sam的个人博客</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">一个程序员的成长记录</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">首页</a>
        
          <a class="main-nav-link" href="/archives">归档</a>
        
          <a class="main-nav-link" href="/about">关于</a>
        
          <a class="main-nav-link" href="/links">友链</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://ydstudios.gitee.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-系统的数据一致性到底是在说什么" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/post/e544327e.html" class="article-date">
  <time datetime="2021-01-17T11:58:02.000Z" itemprop="datePublished">2021-01-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      系统的数据一致性到底是在说什么
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>作为一名程序员，你是不是经常在很多场景，例如看博客、聊天吹水等等时候听到这样一个词”系统数据一致性”，是不是有时候感觉到了迷糊，不知道这个”系统数据一致性”到底是在说什么？其实，你可能只是不明白这个词，但是你肯定在实际工作中发现、解决过这样的问题。</p>
<a id="more"></a>

<h5 id="单体架构下系统数据一致性问题"><a href="#单体架构下系统数据一致性问题" class="headerlink" title="单体架构下系统数据一致性问题"></a>单体架构下系统数据一致性问题</h5><p>在传统的系统应用中，一般都是使用单体架构来构建系统的。即所有的功能模块都放在一起实现，打成一个WAR包部署在Tomcat中，数据一般存放在关系型数据库中，如MySQL数据库。</p>
<img src="https://gitee.com/ydstudios/blogImage/raw/master/img/20210117223211.png" style="zoom:50%;" alt="单体架构图" />

<p>前面我说过即使这种单体架构的系统也是数据一致性的问题的，举一个电商下单的例子，用户提交完订单，系统，系统在订单表order表中写入订单金额、用户等相关数据，在订单明细order_item表中写入商品价格、购买的数量等数据，最后更新商品的库存sku信息。用户下单成功之后，系统操作了order、order_item、sku这三个数据表，对于这三个表的操作无论成功与失败，都应该是原子的，操作成功则都要成功，失败则都要一起失败。不然就会出现脏数据，数据一致性被破坏。</p>
<p>1、 如果操作order和order_item表成功，操作sku表失败，则会导致本应该扣减的库存没有扣减，则商品有可能出现超卖。</p>
<p>2、如果操作order和order_item表失败，操作sku表成功，则会导致本不应该扣减的库存扣减了，则商品有可能出现少卖。</p>
<p>3、如果操作order和sku表成功，order_item操作失败，则这个订单数据丢失，订单后续的操作肯定也是操作不了了。</p>
<p>上面只是简单的举了三种可能出现的情况，也可能会有其他的情况发生。那我们怎么避免这些情况的发生呢？其实这种问题稍微有的开发经验的同学都会想到解决方案，那就是使用数据库的事务，事务的原子性保证上述的步骤成功则一起成功，失败则一起失败。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">order</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> order_item;</span><br><span class="line"><span class="keyword">UPDATE</span> sku;</span><br><span class="line"><span class="keyword">COMMIT</span>; <span class="comment"># ROLLBACK</span></span><br></pre></td></tr></table></figure>
<p><strong>在单体架构的系统下解决内部模块的数据一致性的问题，用数据库的ACID特性就能保证。</strong></p>
<p>单体架构的优点就是相对分布式来说开发简单，功能可以集中管理，模块之间通信没有损耗。但随着业务越来越复杂、需求越来越庞大，人们对系统响应时间、吞吐量和出现故障的时候的系统可用性的要求也越来越高！传统的单体架构系统在这种情况下暴露的缺点也越来越多，人们开始寻求转变。既然部署在一个服务器上的单体架构系统搞不定，那就多部署几台，即用多台单机节点组成集群，再用负载均衡向外提供服务。</p>
<img src="https://gitee.com/ydstudios/blogImage/raw/master/img/20210131220214.png" alt="集群部署" style="zoom:20%;" />

<p>但是这样做还是解决不了单体架构存在的一些问题：</p>
<ul>
<li>只能使用同种语言开发，不能针对不同业务场景利用不同语言的优势开发对应的模块。</li>
<li>系统模块耦合性太强，系统中某一个模块出现问题，例如高并发、大数据场景或者出现bug，整个系统都会受到牵连。</li>
<li>某个模块发布，整个系统都要停机发布，系统所有模块都不能对外提供服务，这样无法快速响应市场需求。</li>
<li>集群负担大，如果想要集群，只能对整个系统进行集群，即使只有一个模块有压力。</li>
</ul>
<blockquote>
<p>集群(Cluster)： 系统单机部署对外服务能力出现瓶颈，则将系统进行多机部署，这些系统对外提供相同的服务，每个单机系统我们称之为节点，多个节点统一起来则可以称之为集群。</p>
</blockquote>
<h5 id="分布式架构下系统数据一致性问题"><a href="#分布式架构下系统数据一致性问题" class="headerlink" title="分布式架构下系统数据一致性问题"></a>分布式架构下系统数据一致性问题</h5><p>天下大事分久必合、合久必分！既然单体架构解决不了问题，那我们就尝试拆分系统，让专业的人做专业的事，那如何进行拆分呢？拆分一般分为水平拆分和垂直拆分。这里说的拆分并不单指数据库拆分，而是所有模块都进行拆分，每个模块都有自己的缓存、数据库等等。</p>
<ul>
<li>水平拆分指的是单一的节点无法满足性能的需求，需要进行数量上的扩展。每一个节点都具有相同的功能，每一个节点都负责一部分请求，节点们组成一个集群，对外进行提供服务。</li>
<li>垂直拆分指的是按照功能进行拆分，秉着”专业的人干专业的事”，把复杂的系统拆分成各个模块。模块之间通过RPC进行通信，可以做到高内聚、低耦合，每个模块独立部署和维护，可以快速迭代响应市场需求。<br>因此，分布式架构在这种背景下应运而生。</li>
</ul>
<img src="https://gitee.com/ydstudios/blogImage/raw/master/img/20210131215841.png" alt="分布式架构" style="zoom:20%;" />

<blockquote>
<p>分布式(Distributed)架构：分布式系统是由集中式系统逐渐演变而来。所谓的集中式系统，就是把系统中所用的功能都集中到一起，从而向外提供服务的单体应用。</p>
</blockquote>
<p>软件行业是没有银弹的，每一个被发明出来的新技术，都是一把双刃剑，都是在特定的领域解决了某些老问题，但是同时也会带来新的问题。那么微服务这种分布式架构解决了什么老问题？同时它又带来了哪些新问题呢？</p>
<h6 id="解决了老问题"><a href="#解决了老问题" class="headerlink" title="解决了老问题"></a>解决了老问题</h6><p>微服务这中分布式架构主要解决了单体架构存在的一些问题。</p>
<ul>
<li>各个服务可以使用不同的语言开发，可以利用不同语言的优势开发不同模块。</li>
<li>服务之间可以做到高内聚、低耦合。每个服务可以独立维护、部署，可以快速响应市场需求。</li>
<li>可以单独对某个有高并发、大流量的服务单独进行优化，不浪费资源。</li>
</ul>
<h6 id="带来了新问题"><a href="#带来了新问题" class="headerlink" title="带来了新问题"></a>带来了新问题</h6><ul>
<li>系统的监控难度加大。</li>
<li>数据的一致性成为问题。</li>
<li>系统的复杂度提高，系统的维护、设计成本增加，调试、纠错难度加大。</li>
</ul>
<p>新问题中的 <code>数据一致性问题</code>才是本文接下来的重点。 </p>
<h6 id="为啥会有这个数据一致性问题呢"><a href="#为啥会有这个数据一致性问题呢" class="headerlink" title="为啥会有这个数据一致性问题呢"></a>为啥会有这个数据一致性问题呢</h6><p>单体架构按照文中的说法，是一种不太时髦的架构方式，都能轻松解决数据一致性问题，新发明的分布式架构却又成了一个棘手的问题，这个到底是技术的进步还是技术在退步呢？哈哈😄😄(我的一点点吐槽)！！接下来我来解释一下为啥分布式系统会有这样的问题。<br>分布式系统每个功能大都部署在不同的服务器上，部署在不同国家和地区的服务器中，部署在不同的网络中，部署在不同国家和地区的网络中。这样一个需要大量的服务器共同协作，向外提供服务的系统，面临着诸多的挑战：</p>
<ol>
<li><p>良莠不齐的服务器和系统能力<br>分布式系统中的服务器，可能配置不一样，其上部署的系统可能也是由不同的程序语言、架构实现，因此处理请求的能力也就不一样。</p>
</li>
<li><p>不可靠的网络<br>如上文所说，系统中各个服务可能部署在不同国家和地区，各个服务通过网络进行通信，但是网络是不可靠的。网络经常会出现抖动、延时、分割、丢包等问题。<br>网络通信中最让人头痛的是因为网络抖动、延时等问题导致系统之间的通信出现超时：A服务向B服务发出请求，A服务没有在约定的时间内接受到B服务的响应，你不能确定B服务到底有没有处理完A服务的请求，这样的不确定性就需要我们进行重试处理，那么B服务就要解决请求幂等性问题。</p>
</li>
</ol>
<blockquote>
<p>支付宝出现过服务器的电缆被挖断的问题。<br>服务器的机房发生火灾、断电等事故。</p>
</blockquote>
<ol start="3">
<li>普遍存在的单点故障<br>分布式系统为了保证故障发生的时候，系统仍然保证可用，每个模块都采用集群部署。单个节点的故障概率较低，但是节点数量达到一定规模时，系统中的节点出现故障的概率就变高了。</li>
</ol>
<p>分布式系统就是这样一些处在不同区域、有着不同能力和拥有单一功能的服务组成，他们通力合作才能向外提供服务，那如何保证他们的状态、信息一致并且协调有序就成了一个难题。</p>
<p>分布式系统就是要解决解决集中式的单体架构系统的各种缺陷，实现整个系统的 <code>高性能</code>、<code>高可用</code>、<code>可扩展</code>,但是要实现这三个目标并不容易，将系统进行拆分的过程中会出现上文中说到的问题，为了解决这些问题，诞生了很多关于分布式的基本理论，比如CAP、BASE等等。</p>
<h6 id="我们先来说说CAP理论"><a href="#我们先来说说CAP理论" class="headerlink" title="我们先来说说CAP理论"></a>我们先来说说CAP理论</h6><p>这个CAP理论相信很多人都听说过，下面请允许我写下教科书般的理论内容：</p>
<blockquote>
<p>CAP原则又称CAP定理，指的是在一个分布式系统中，Consistency（一致性）、 Availability（可用性）、Partition tolerance（分区容错性），三者不可得兼。</p>
<ol>
<li>一致性（C）：在分布式系统中的所有数据备份，在同一时刻是否同样的值。（等同于所有节点访问同一份最新的数据副本）</li>
<li>可用性（A）：保证每个请求不管成功或者失败都有响应。</li>
<li>分区容忍性（P）：系统中任意信息的丢失或失败不会影响系统的继续运作。</li>
</ol>
</blockquote>
<p>啥玩意啊上来就和我说分布式系统只能满足CAP中的两点，不可鱼和熊掌兼得。</p>

      
    </div>
         
            <div>
  <ul class="post-copyright">
    <li class="post-copyright-author">
    <strong>作者:  </strong>Sam</a>
    </li>
    <li><span>发布时间: </span>2021-01-17 11:58:02</li>
    <li><span>最后更新: </span>2021-02-04 20:21:00</li>
    <li class="post-copyright-link">
    <strong>文章链接:  </strong>
    <a href="/post/e544327e.html" target="_blank" title="系统的数据一致性到底是在说什么">https://ydstudios.gitee.io/post/e544327e.html</a>
    </li>
    <li class="post-copyright-license">
      <strong>版权声明:   </strong>
      本网所有文章除特别声明外，均采用 <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">署名-非商业性使用-禁止演绎 4.0 国际</a>
      许可协议，转载请保留原文链接及作者!
    </li>
  </ul>
<div>
         
    <footer class="article-footer">
      <a data-url="https://ydstudios.gitee.io/post/e544327e.html" data-id="ckkr19epf0069kay1888b1o3q" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%B8%80%E8%87%B4%E6%80%A7/" rel="tag">一致性</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" rel="tag">分布式</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/post/122ee231.html" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer >> </strong>
      <div class="article-nav-title">
        
          RocketMQ的消费模式
        
      </div>
    </a>
  
  
    <a href="/post/b4e52eb3.html" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older << </strong>
      <div class="article-nav-title">2020年的年终小结</div>
    </a>
  
</nav>

  
</article>

</section>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 Sam<br>
      <!--Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>-->
      <p>备案号:<a href="http://www.miitbeian.gov.cn/" target="_blank" rel="nofollow">苏ICP备17069935号-1</a></p>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
    <a href="/about" class="mobile-nav-link">关于</a>
  
    <a href="/links" class="mobile-nav-link">友链</a>
  
</nav>
    

<script src="https://cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>